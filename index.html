<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bomberman Multiplayer</title>
  <style>
    /* Estilos Globais */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #333;
      color: #FFF;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* Alinha no topo em telas pequenas */
      min-height: 100vh;
      overflow: hidden; /* Evita scroll no celular */
    }

    h1 {
      text-shadow: 1px 1px #000;
      font-size: 2rem;
      color: #FFDC00;
      margin-bottom: 20px;
    }

    /* Cont√™iner Principal */
    .container {
      width: 100vw; /* Ocupa a largura total */
      max-width: 1000px;
      min-height: 100vh; /* Ocupa a altura total */
      margin: 0;
      padding: 10px; /* Padding menor para mobile */
      background-color: #222;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      box-sizing: border-box; /* Inclui padding na largura */
    }

    /* Estilos dos Bot√µes e Inputs */
    button {
      background-color: #0074D9;
      color: #FFF;
      border: 2px solid #FFF;
      padding: 15px 20px;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 5px;
      transition: background-color 0.2s;
      text-shadow: 1px 1px #000;
      font-weight: bold;
    }

    button:hover {
      background-color: #0056b3;
    }
    
    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    input[type="text"],
    select {
      padding: 10px;
      font-size: 1rem;
      border: 2px solid #FFF;
      background-color: #444;
      color: #FFF;
      border-radius: 5px;
      margin: 5px 0 15px 0;
      width: calc(100% - 24px); /* Ajuste para padding e borda */
      box-sizing: border-box;
    }

    label {
      font-size: 1rem;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    /* Estilo para o toggle na home */
    .home-option {
      margin: 15px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .home-option label {
        margin: 0 10px 0 0;
    }

    /* Telas (Home, Lobby, Jogo) */
    .screen {
      display: none; /* Come√ßam escondidas */
      width: 100%;
      animation: fadeIn 0.5s;
    }

    #screen-home, #screen-lobby {
      text-align: center;
    }

    #screen-game {
      display: none;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Tela de Jogo - Layout */
    #game-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%; /* Ocupa espa√ßo dispon√≠vel */
      max-width: 600px; /* Limite m√°ximo */
    }
    
    #game-canvas-container {
      position: relative; /* Contexto para a notifica√ß√£o */
      width: 100%; /* Garante que o container se ajuste */
    }

    canvas {
      /* REMOVIDO background-color: #111; O ch√£o agora √© desenhado */
      border: 4px solid #FFF;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
      
      /* --- MUDAN√áA PRINCIPAL PARA RESPONSIVIDADE --- */
      width: 100%; /* Canvas fluido */
      max-width: 600px; /* Limite m√°ximo */
      height: auto; /* Mant√©m a propor√ß√£o (aspect ratio) */
      display: block;
    }

    #game-sidebar {
      width: 200px; /* Largura fixa no desktop */
      min-width: 200px; /* Evita encolher */
      background-color: #333;
      padding: 15px;
      border-radius: 8px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
      box-sizing: border-box;
    }
    
    /* Notifica√ß√£o sobre o Jogo */
    #game-notification {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.85);
      color: #FFF;
      padding: 20px;
      border-radius: 10px;
      font-size: 1.1rem; /* Um pouco menor no mobile */
      font-weight: bold;
      text-align: center;
      z-index: 100;
      border: 2px solid #FFDC00;
      text-shadow: 1px 1px #000;
      display: none; /* Come√ßa escondida */
      pointer-events: none; /* N√£o bloquear cliques no canvas */
      animation: fadeInOut 3s ease-in-out forwards;
      width: 80%;
      box-sizing: border-box;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }

    #status {
      font-size: 0.9rem;
      margin-top: 10px;
      color: #AAA;
      height: 20px;
    }
    
    #btn-back-to-lobby {
      margin-top: 15px;
      width: 100%;
      background-color: #FF4136;
      display: none; /* Come√ßa escondido */
    }

    /* Tela de Lobby */
    #lobby-info {
      background-color: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    #room-code-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #FFDC00;
      background-color: #111;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: inline-block;
    }
    
    #player-list-container {
      text-align: left;
      max-width: 400px;
      margin: 0 auto 20px auto;
    }
    
    .player-lobby-item {
      font-size: 1rem;
      padding: 10px;
      border-bottom: 1px solid #555;
    }
    
    #host-panel {
      margin-top: 20px;
      background-color: #444;
      padding: 15px;
      border-radius: 8px;
    }

    /* Placar (Sidebar) */
    
    #scoreboard {
      max-height: 250px; /* Limita a altura */
      overflow-y: auto; /* Adiciona scroll se necess√°rio */
      scrollbar-width: thin;
      scrollbar-color: #888 #444;
      margin-bottom: 15px; /* Espa√ßo para o bot√£o de voltar */
    }
    
    .scoreboard-player {
      background-color: #444;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      border-left: 8px solid; /* A cor do jogador vai aqui */
      transition: opacity 0.3s, background-color 0.3s;
    }
    
    .scoreboard-player.dead {
      background-color: #333;
      opacity: 0.5;
    }
    
    .player-name {
      font-size: 1rem;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .player-score {
      font-size: 1.1rem;
      float: right;
      font-weight: bold;
    }

    .player-stats {
      font-size: 0.9rem;
      margin-top: 5px;
      color: #CCC;
    }
    
    /* Controles de Toque */
    #touch-dpad {
      position: fixed;
      bottom: 20px; 
      left: 10px; 
      width: 135px; 
      height: 135px; 
      display: none; 
      z-index: 100;
      transform: scale(0.95); 
      transform-origin: bottom left;
    }
    
    #touch-action-button {
      position: fixed;
      bottom: 25px; 
      right: 15px; 
      width: 110px; 
      height: 110px; 
      display: none; 
      z-index: 100;
      transform: scale(0.95);
      transform-origin: bottom right;
    }
    
    .touch-button {
      position: absolute;
      width: 50px; 
      height: 50px; 
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      color: white;
      font-size: 1.5rem; 
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none; 
    }
    
    .touch-button:active {
      background-color: rgba(255, 255, 255, 0.6);
    }
    
    #touch-up { top: 0; left: 42.5px; }
    #touch-left { top: 42.5px; left: 0; }
    #touch-down { top: 85px; left: 42.5px; }
    #touch-right { top: 42.5px; right: 0; }
    
    #touch-bomb {
      width: 110px;
      height: 110px;
      border-radius: 50%; 
      font-size: 2.5rem; 
      background-color: rgba(255, 65, 54, 0.4); 
      border-color: rgba(255, 65, 54, 0.7);
    }
    
    #touch-bomb:active {
       background-color: rgba(255, 65, 54, 0.7);
    }
    
    
    /* --- MEDIA QUERY PARA RESPONSIVIDADE --- */
    @media (max-width: 850px) { /* Breakpoint */
      
      .container {
        padding: 10px; 
      }
    
      #screen-game {
        flex-direction: column; 
        align-items: center; 
      }
      
      #game-area {
        width: 100%;
        max-width: 100%; 
      }
      
      #game-sidebar {
        width: 100%; 
        max-width: 600px; 
        margin-top: 15px; 
      }
    }
    
    @media (max-width: 400px) {
        h1 { font-size: 1.5rem; }
        button { padding: 12px 15px; font-size: 0.9rem; }
    }

  </style>
</head>
<body>

  <div class="container">

    <!-- Tela 1: Home --><div id="screen-home" class="screen" style="display: block;">
      <h1>Bomberman</h1>
      
      <div>
        <label for="player-name">Seu Nome:</label>
        <input type="text" id="player-name" value="Jogador">
      </div>
      
       <div>
        <label for="player-emoji">Personagem:</label>
        <select id="player-emoji">
          <option value="üòÄ">üòÄ Rosto</option>
          <option value="üòé">üòé √ìculos</option>
          <option value="ü§†">ü§† Cowboy</option>
          <option value="üëΩ">üëΩ Alien</option>
          <option value="üëª">üëª Fantasma</option>
          <option value="üéÉ">üéÉ Ab√≥bora</option>
          <option value="ü§ñ">ü§ñ Rob√¥</option>
          <option value="üò∫">üò∫ Gato</option>
          <option value="üêº">üêº Panda</option>
          <option value="üê∏">üê∏ Sapo</option>
        </select>
      </div>
      
      <!-- Toggle de Controles --><div class="home-option">
        <label for="toggle-touch-controls">Exibir Controles de Toque:</label>
        <input type="checkbox" id="toggle-touch-controls">
      </div>

      <button id="btn-create-room" style="margin-top: 20px;">Criar Sala</button>
      
      <hr style="border-color: #555; margin: 30px 0;">
      
      <div>
        <label for="room-code">C√≥digo da Sala:</label>
        <input type="text" id="room-code" maxlength="4">
      </div>
      <button id="btn-join-room">Entrar na Sala</button>
    </div>

    <!-- Tela 2: Lobby --><div id="screen-lobby" class="screen">
      <h1>Lobby</h1>
      <div id="lobby-info">
        <span>C√≥digo da Sala:</span>
        <div id="room-code-display">ABCD</div>
      </div>
      
      <h2>Jogadores:</h2>
      <div id="player-list-container">
        <!-- Jogadores --></div>
      
      <div id="host-panel" style="display: none;">
        <h3>Painel do Host</h3>
        <button id="btn-add-bot">Adicionar Bot</button>
        <button id="btn-start-game" style="background-color: #2ECC40;">Iniciar Jogo</button>
      </div>
    </div>

    <!-- Tela 3: Jogo --><div id="screen-game" class="screen">
      <!-- √Årea do Jogo --><div id="game-area">
        <div id="game-canvas-container">
          <canvas id="game-canvas" width="600" height="520"></canvas>
          <div id="game-notification">Mensagem!</div>
        </div>
        <div id="status">Conectando...</div>
      </div>
      
      <!-- Sidebar --><div id="game-sidebar">
        <div id="scoreboard">
          <!-- Placar --></div>
        
        <button id="btn-back-to-lobby">Voltar ao Lobby</button>
      </div>
    </div>
  </div>

  <!-- Controles de Toque --><div id="touch-dpad">
    <div id="touch-up" class="touch-button">‚ñ≤</div>
    <div id="touch-left" class="touch-button">‚óÑ</div>
    <div id="touch-down" class="touch-button">‚ñº</div>
    <div id="touch-right" class="touch-button">‚ñ∫</div>
  </div>
  <div id="touch-action-button">
    <div id="touch-bomb" class="touch-button">üí£</div>
  </div>


  <script>
    // --- Configura√ß√µes do Cliente ---
    const GRID_SIZE = 40;
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    
    // Elementos da UI
    const screens = {
      home: document.getElementById('screen-home'),
      lobby: document.getElementById('screen-lobby'),
      game: document.getElementById('screen-game'),
    };
    const statusEl = document.getElementById('status');
    const notificationEl = document.getElementById('game-notification');
    const scoreboardEl = document.getElementById('scoreboard');
    const btnBackToLobby = document.getElementById('btn-back-to-lobby');
    
    // Controles de Toque
    const toggleTouchControls = document.getElementById('toggle-touch-controls');
    const touchDpad = document.getElementById('touch-dpad');
    const touchActionButton = document.getElementById('touch-action-button');

    // Estado local do jogo
    let ws;
    let localPlayerId = null;
    let localRoomCode = null;
    let localHostId = null; 
    let isGameActive = false;
    let textures = {}; // MANTIDO para explos√£o
    let texturesLoaded = false;
    let lastNotificationTimer = null;
    let moveInterval = null; 
    let showTouchControlsPreference = false; 
    
    // Estado local do mundo do jogo
    let localGameState = {
      players: {},
      gameMap: [],
      bombs: [], 
      powerUps: [],
      explosions: []
    };
    
    // --- Carregamento de Texturas (ATUALIZADO) ---
    
    // URLs das texturas (REMOVIDO floor, solidWall, softWall)
    const textureSources = {
      explosion: 'https://placehold.co/40x40/FFA500/FFA500?text=.'
    };

    function preloadTextures() {
      let promises = [];
      // Apenas a textura de explos√£o
      if (textureSources.explosion) {
          promises.push(new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
              textures['explosion'] = img;
              resolve();
            };
            img.onerror = () => reject(new Error(`Falha ao carregar explos√£o`));
            img.src = textureSources.explosion;
          }));
      } else {
          // Se n√£o houver textura de explos√£o, resolve imediatamente
          promises.push(Promise.resolve());
      }
      
      // Quando todas as imagens carregarem (ou se n√£o houver), inicia
      Promise.all(promises)
        .then(() => {
          console.log('Texturas carregadas (ou puladas).');
          texturesLoaded = true; // Mesmo que n√£o tenha carregado nada
          connectWebSocket(); 
        })
        .catch(err => console.error(err));
    }

    // --- Conex√£o WebSocket ---

    function connectWebSocket() {
      let host = window.location.host;
      if (!host) {
        console.warn("Host n√£o encontrado. Usando 'localhost:3000' como padr√£o.");
        host = 'localhost:3000';
      }
      const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      const wsUrl = wsProtocol + host;

      try {
        ws = new WebSocket(wsUrl);
        setupWebsocketListeners(ws);
      } catch (error) {
        console.error('Falha ao conectar ao WebSocket:', error);
        statusEl.textContent = 'Erro de conex√£o.';
      }
    }

    function setupWebsocketListeners(socket) {
      socket.onopen = () => {
        statusEl.textContent = 'Conectado. Pronto para criar ou entrar na sala.';
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        switch (data.type) {
          // Handlers de Lobby
          case 'room_created':
          case 'room_joined':
            localPlayerId = data.playerId;
            localRoomCode = data.roomCode;
            localHostId = data.hostId; 
            updateLobby(data.roomCode, data.hostId, data.players);
            showScreen('lobby');
            break;
          
          case 'lobby_update':
            if (data.hostId) localHostId = data.hostId; 
            updateLobby(localRoomCode, localHostId, data.players);
            break;
            
          // Handlers de In√≠cio/Fim de Jogo
          case 'game_start':
            localGameState.players = data.initialState.players;
            localGameState.gameMap = data.initialState.gameMap;
            localGameState.bombs = data.initialState.bombs || [];
            localGameState.powerUps = data.initialState.powerUps || [];
            localGameState.explosions = []; 
            
            if (showTouchControlsPreference) {
              touchDpad.style.display = 'block';
              touchActionButton.style.display = 'block';
            } else {
              touchDpad.style.display = 'none';
              touchActionButton.style.display = 'none';
            }
            
            updateScoreboard();
            isGameActive = true;
            btnBackToLobby.style.display = 'none';
            showScreen('game');
            requestAnimationFrame(gameLoop); 
            showGameNotification("O Jogo Come√ßou!");
            break;

          case 'round_start':
            localGameState.gameMap = data.newState.gameMap;
            localGameState.players = data.newState.players;
            localGameState.bombs = [];
            localGameState.powerUps = [];
            localGameState.explosions = [];
            
            updateScoreboard(); 
            isGameActive = true;
            btnBackToLobby.style.display = 'none';
            requestAnimationFrame(gameLoop); 
            showGameNotification("Nova Rodada!");
            break;
            
          case 'round_over':
            isGameActive = false; 
            showGameNotification(`${data.winnerName} venceu a rodada!`);
            break;

          case 'game_over':
            isGameActive = false; 
            showGameNotification(`FIM DE JOGO! ${data.winnerName} √© o campe√£o!`);
            btnBackToLobby.style.display = 'block'; 
            break;
            
          case 'sudden_death': // Bots
             showGameNotification("Morte S√∫bita! Apenas bots restaram!");
             break;

          case 'sudden_death_starting': // Humanos
            showGameNotification("Morte S√∫bita! Blocos caindo!");
            break;
            
          case 'player_left':
            delete localGameState.players[data.playerId];
            if (data.newHostId) {
              localHostId = data.newHostId; 
              updateLobby(localRoomCode, data.newHostId, localGameState.players);
            }
            updateScoreboard();
            break;

          // Handlers de Jogo
          case 'player_moved':
            if (localGameState.players[data.playerId]) {
              localGameState.players[data.playerId].x = data.x;
              localGameState.players[data.playerId].y = data.y;
            }
            break;
          
          case 'bomb_moved': // Chute
            const kickedBomb = localGameState.bombs.find(b => b.id === data.bombId);
            if (kickedBomb) {
                kickedBomb.x = data.x;
                kickedBomb.y = data.y;
            }
            break;
            
          case 'bomb_placed':
             localGameState.bombs.push({
                 id: data.bomb.id,
                 x: data.bomb.x,
                 y: data.bomb.y,
                 isSuper: data.bomb.isSuper 
             });
            break;
            
          case 'bomb_exploded':
            localGameState.bombs = localGameState.bombs.filter(b => b.id !== data.bombId);
            data.explosionTiles.forEach(tile => {
              const explosionId = `${tile.x}-${tile.y}-${Date.now()}`;
              localGameState.explosions.push({ ...tile, id: explosionId });
              setTimeout(() => {
                localGameState.explosions = localGameState.explosions.filter(e => e.id !== explosionId);
              }, 500);
            });
            break;
            
          case 'map_update':
            data.tiles.forEach(tile => {
              localGameState.gameMap[tile.y][tile.x] = tile.newType;
            });
            break;
            
          case 'powerup_spawned':
            localGameState.powerUps.push(data.powerUp);
            break;
            
          case 'powerup_collected':
            const pUpIndex = localGameState.powerUps.findIndex(p => p.id === data.powerUpId);
            if (pUpIndex > -1) {
              const player = localGameState.players[data.playerId];
              if (player) {
                  player.maxBombs = data.maxBombs;
                  player.bombPower = data.bombPower;
                  player.hasSuperBomb = data.hasSuperBomb;
                  const pUpType = localGameState.powerUps[pUpIndex].type;
                  if (pUpType === 'bomb-pass') player.canPassBombs = true;
                  if (pUpType === 'wall-pass') player.canPassWalls = true;
                  if (pUpType === 'kick-bomb') player.canKickBombs = true;
              }
              localGameState.powerUps.splice(pUpIndex, 1);
              updateScoreboard(); 
            }
            break;
            
          case 'player_cursed': 
            if (localGameState.players[data.playerId]) {
                localGameState.players[data.playerId].curse = data.curse;
                showGameNotification(`${localGameState.players[data.playerId].name} pegou uma caveira! (${data.curse})`);
            }
            localGameState.powerUps = localGameState.powerUps.filter(p => p.x !== localGameState.players[data.playerId].x || p.y !== localGameState.players[data.playerId].y);
            updateScoreboard(); 
            break;

          case 'player_cured': 
              if (localGameState.players[data.playerId]) {
                  localGameState.players[data.playerId].curse = null;
                  showGameNotification(`${localGameState.players[data.playerId].name} foi curado!`);
              }
              updateScoreboard(); 
              break;
            
          case 'curse_transferred': 
            if (localGameState.players[data.fromId]) localGameState.players[data.fromId].curse = null;
            if (localGameState.players[data.toId]) localGameState.players[data.toId].curse = data.curse;
            showGameNotification(`Maldi√ß√£o passada para ${localGameState.players[data.toId].name}!`);
            updateScoreboard(); 
            break;

          case 'player_update': 
            if (localGameState.players[data.playerId]) {
              const player = localGameState.players[data.playerId];
              if (data.isAlive !== undefined) player.isAlive = data.isAlive;
              if (data.bombPower !== undefined) player.bombPower = data.bombPower;
              if (data.maxBombs !== undefined) player.maxBombs = data.maxBombs;
              if (data.hasSuperBomb !== undefined) player.hasSuperBomb = data.hasSuperBomb; 
              updateScoreboard(); 
            }
            break;
            
          case 'score_update':
            Object.values(data.players).forEach(p => {
              if (localGameState.players[p.id]) {
                localGameState.players[p.id].score = p.score;
              }
            });
            updateScoreboard();
            break;
            
          // Outros
          case 'error_message':
            alert(data.message); 
            break;
        }
      };

      socket.onclose = () => {
        if (statusEl.textContent === 'Conectando...') {
           statusEl.textContent = 'Falha ao conectar. Verifique o servidor.';
        } else {
           statusEl.textContent = 'Desconectado do servidor.';
        }
        isGameActive = false;
        showScreen('home');
      };

      socket.onerror = (err) => {
        console.error('Erro no WebSocket:', err);
        statusEl.textContent = 'Erro de conex√£o. O servidor (server.js) pode estar offline ou travado.';
      };
    }

    // --- Renderiza√ß√£o (Canvas) ---

    function gameLoop() {
      if (!isGameActive) { // N√£o precisa mais checar texturesLoaded aqui
        return; 
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 1. Desenha o Ch√£o e Paredes (ATUALIZADO para CSS-like)
      for (let y = 0; y < localGameState.gameMap.length; y++) {
        for (let x = 0; x < localGameState.gameMap[y].length; x++) {
          const tileType = localGameState.gameMap[y][x];
          const posX = x * GRID_SIZE;
          const posY = y * GRID_SIZE;

          if (tileType === 1) { // S√≥lida
            ctx.fillStyle = '#444'; // Cinza escuro
            ctx.fillRect(posX, posY, GRID_SIZE, GRID_SIZE);
            ctx.strokeStyle = '#222'; // Borda mais escura
            ctx.lineWidth = 2;
            ctx.strokeRect(posX + 1, posY + 1, GRID_SIZE - 2, GRID_SIZE - 2); // +1/-2 para borda interna
          } else if (tileType === 2) { // Destrut√≠vel
            ctx.fillStyle = '#8B4513'; // Marrom
            ctx.fillRect(posX, posY, GRID_SIZE, GRID_SIZE);
            ctx.strokeStyle = '#5A2D0C'; // Borda marrom escura
            ctx.lineWidth = 2;
            ctx.strokeRect(posX + 1, posY + 1, GRID_SIZE - 2, GRID_SIZE - 2);
          } else { // Ch√£o (0)
            ctx.fillStyle = '#666'; // Cinza padr√£o
            ctx.fillRect(posX, posY, GRID_SIZE, GRID_SIZE);
             // Poderia adicionar um padr√£o sutil aqui se quisesse
          }
        }
      }
      
      // 2. Desenha Power-ups
      localGameState.powerUps.forEach(p => {
        const x = p.x * GRID_SIZE;
        const y = p.y * GRID_SIZE;

        // Desenha a caixa de fundo
        ctx.fillStyle = 'rgba(0, 100, 255, 0.3)'; 
        ctx.fillRect(x + 2, y + 2, GRID_SIZE - 4, GRID_SIZE - 4);
        ctx.strokeStyle = '#FFFFFF'; 
        ctx.lineWidth = 1;
        ctx.strokeRect(x + 2, y + 2, GRID_SIZE - 4, GRID_SIZE - 4);

        // Desenha o emoji do power-up
        ctx.font = `${GRID_SIZE * 0.6}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        let emoji = '‚ùì';
        if (p.type === 'bomb-up') emoji = 'üí£';
        if (p.type === 'fire-up') emoji = 'üî•';
        if (p.type === 'bomb-pass') emoji = '‚û°Ô∏è'; 
        if (p.type === 'wall-pass') emoji = 'üëª'; 
        if (p.type === 'kick-bomb') emoji = 'üëü'; 
        if (p.type === 'skull') emoji = 'üíÄ';     
        if (p.type === 'super-bomb') emoji = 'üí•'; 
        ctx.fillText(emoji, x + (GRID_SIZE / 2), y + (GRID_SIZE / 2));
      });

      // 3. Desenha Bombas
      localGameState.bombs.forEach(bomb => {
        const x = bomb.x * GRID_SIZE;
        const y = bomb.y * GRID_SIZE;
        const halfGrid = GRID_SIZE / 2;
        const radius = halfGrid * 0.8;

        // C√≠rculo
        ctx.fillStyle = bomb.isSuper ? '#FF4136' : '#111111'; 
        ctx.beginPath();
        ctx.arc(x + halfGrid, y + halfGrid, radius, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = '#FFFFFF'; 
        ctx.lineWidth = 2;
        ctx.stroke();

        // Letra
        ctx.fillStyle = '#FFFFFF';
        ctx.font = `bold ${GRID_SIZE * 0.5}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(bomb.isSuper ? 'S' : 'B', x + halfGrid, y + halfGrid * 1.05); 
      });
      
      // 4. Desenha Explos√µes
      if (textures.explosion) {
        localGameState.explosions.forEach(exp => {
          ctx.drawImage(textures.explosion, exp.x * GRID_SIZE, exp.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
        });
      } else {
         // Fallback se a textura de explos√£o n√£o carregar
         localGameState.explosions.forEach(exp => {
             ctx.fillStyle = 'orange';
             ctx.fillRect(exp.x * GRID_SIZE, exp.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
         });
      }

      // 5. Desenha Jogadores
      Object.values(localGameState.players).forEach(player => {
        if (player.isAlive) { 
          const x = player.x * GRID_SIZE;
          const y = player.y * GRID_SIZE;
          const halfGrid = GRID_SIZE / 2;
          
          // C√≠rculo
          ctx.fillStyle = player.color;
          if (player.curse) {
             ctx.globalAlpha = 0.6 + Math.sin(Date.now() / 100) * 0.3; 
          }
          ctx.beginPath();
          ctx.arc(x + halfGrid, y + halfGrid, halfGrid * 0.9, 0, 2 * Math.PI);
          ctx.fill();
          ctx.globalAlpha = 1.0; 
          
          // Emoji
          ctx.font = `${GRID_SIZE * 0.7}px sans-serif`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(player.emoji, x + halfGrid, y + (halfGrid * 1.1)); 
        }
      });

      requestAnimationFrame(gameLoop);
    }
    
    // --- Fun√ß√µes de UI ---

    function showScreen(screenName) {
      Object.values(screens).forEach(screen => screen.style.display = 'none');
      screens[screenName].style.display = (screenName === 'game') ? 'flex' : 'block';
    }

    function updateLobby(roomCode, hostId, players) {
      document.getElementById('room-code-display').textContent = roomCode;
      
      const listEl = document.getElementById('player-list-container');
      listEl.innerHTML = '';
      Object.values(players).forEach(p => {
        const item = document.createElement('div');
        item.className = 'player-lobby-item';
        
        const colorBox = `<span style="border-left: 6px solid ${p.color}; padding-left: 8px; font-size: 1.5rem;">${p.emoji}</span>`;
        
        let hostTag = (p.id === hostId) ? ' (Host) üëë' : '';
        item.innerHTML = `${colorBox} ${p.name} ${hostTag}`;
        listEl.appendChild(item);
      });
      
      document.getElementById('host-panel').style.display = (localPlayerId === hostId) ? 'block' : 'none';
      document.getElementById('btn-add-bot').disabled = Object.keys(players).length >= 5;
      document.getElementById('btn-start-game').disabled = Object.keys(players).length < 2;
    }

    function updateScoreboard() {
      if (!localGameState || !localGameState.players) return; 
      
      scoreboardEl.innerHTML = ''; 
      
      const sortedPlayers = Object.values(localGameState.players).sort((a, b) => b.score - a.score);
      
      sortedPlayers.forEach(p => {
        const item = document.createElement('div');
        item.className = 'scoreboard-player';
        item.style.borderColor = p.color;
        
        if (!p.isAlive) {
          item.classList.add('dead');
        }
        
        let curseIcon = '';
        if (p.curse === 'reverse') curseIcon = 'üîÑ';
        if (p.curse === 'slow') curseIcon = 'üê¢';
        
        let superBombIcon = p.hasSuperBomb ? 'üí•' : '';
        
        item.innerHTML = `
          <div class="player-score">${p.emoji} ${p.score}</div>
          <div class="player-name">${p.name} ${curseIcon}</div>
          <div class="player-stats">
            üí£ ${p.maxBombs} &nbsp;&nbsp; üî• ${p.bombPower} ${superBombIcon}
          </div>
        `;
        scoreboardEl.appendChild(item);
      });
    }

    function showGameNotification(message) {
      if (lastNotificationTimer) {
        clearTimeout(lastNotificationTimer);
      }
      
      notificationEl.textContent = message;
      notificationEl.style.display = 'block';
      notificationEl.style.animation = 'none'; 
      void notificationEl.offsetWidth; 
      notificationEl.style.animation = 'fadeInOut 3s ease-in-out forwards';
      
      lastNotificationTimer = setTimeout(() => {
        notificationEl.style.display = 'none';
      }, 3000);
    }
    
    // --- Handlers de Input (Teclado) ---

    window.addEventListener('keydown', (e) => {
      if (!isGameActive) return;

      switch (e.key) {
        case 'ArrowUp': case 'w': sendMove('up'); break;
        case 'ArrowDown': case 's': sendMove('down'); break;
        case 'ArrowLeft': case 'a': sendMove('left'); break;
        case 'ArrowRight': case 'd': sendMove('right'); break;
        case ' ': e.preventDefault(); placeBomb(); break;
      }
    });

    // --- Handlers de Input (Bot√µes da UI) ---

    document.getElementById('btn-create-room').onclick = () => {
      showTouchControlsPreference = toggleTouchControls.checked;
      ws.send(JSON.stringify({
        type: 'create_room',
        name: document.getElementById('player-name').value,
        emoji: document.getElementById('player-emoji').value
      }));
    };
    
    document.getElementById('btn-join-room').onclick = () => {
      showTouchControlsPreference = toggleTouchControls.checked;
      const code = document.getElementById('room-code').value.toUpperCase();
      if (code.length === 4) {
        ws.send(JSON.stringify({
          type: 'join_room',
          roomCode: code,
          name: document.getElementById('player-name').value,
          emoji: document.getElementById('player-emoji').value
        }));
      } else {
        alert('C√≥digo da sala deve ter 4 caracteres.');
      }
    };
    
    document.getElementById('btn-add-bot').onclick = () => ws.send(JSON.stringify({ type: 'add_bot' }));
    document.getElementById('btn-start-game').onclick = () => ws.send(JSON.stringify({ type: 'start_game' }));
    btnBackToLobby.onclick = () => window.location.reload();
    
    // --- L√≥gica de A√ß√£o ---

    function sendMove(direction) {
      if (!isGameActive) return;
      ws.send(JSON.stringify({ type: 'move', direction: direction }));
    }

    function placeBomb() {
      if (!isGameActive) return;
      ws.send(JSON.stringify({ type: 'place_bomb' }));
    }
    
    // --- Handlers de Input (Toque) ---
        
    function handleMovePress(direction) {
      if (moveInterval) clearInterval(moveInterval); 
      sendMove(direction); 
      moveInterval = setInterval(() => sendMove(direction), 150);
    }
    
    function handleMoveRelease() {
      if (moveInterval) clearInterval(moveInterval); 
      moveInterval = null;
    }
    
    const dpadButtons = [
      { id: 'touch-up', dir: 'up' }, { id: 'touch-down', dir: 'down' },
      { id: 'touch-left', dir: 'left' }, { id: 'touch-right', dir: 'right' }
    ];
    
    dpadButtons.forEach(btn => {
      const element = document.getElementById(btn.id);
      element.addEventListener('mousedown', (e) => { e.preventDefault(); handleMovePress(btn.dir); });
      element.addEventListener('touchstart', (e) => { e.preventDefault(); handleMovePress(btn.dir); }, { passive: false });
    });

    window.addEventListener('mouseup', handleMoveRelease);
    window.addEventListener('touchend', handleMoveRelease);

    const bombButton = document.getElementById('touch-bomb');
    bombButton.addEventListener('mousedown', (e) => { e.preventDefault(); placeBomb(); });
    bombButton.addEventListener('touchstart', (e) => { e.preventDefault(); placeBomb(); }, { passive: false });


    // --- Inicializa√ß√£o ---
    function initializeApp() {
      const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
      if (isMobile) {
        toggleTouchControls.checked = true;
      }
      showTouchControlsPreference = toggleTouchControls.checked; 
      
      toggleTouchControls.addEventListener('change', (e) => {
         showTouchControlsPreference = e.target.checked;
      });
      
      preloadTextures(); 
    }
    
    initializeApp();
  </script>
</body>
</html>

